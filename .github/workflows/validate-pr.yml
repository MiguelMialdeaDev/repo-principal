name: Validate Breaking Changes Android

on:
  pull_request:
    branches: [master]

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  build-main-repo:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo principal
        uses: actions/checkout@v3

      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Setup Gradle
        uses: gradle/gradle-build-action@v2
        with:
          cache-read-only: false

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Build all shared modules
        run: ./gradlew assembleRelease --no-daemon

      - name: Run tests
        run: ./gradlew test --no-daemon

      - name: Publish to local maven
        run: ./gradlew publishToMavenLocal --no-daemon

      - name: Upload shared libraries
        uses: actions/upload-artifact@v4
        with:
          name: shared-libs
          path: ~/.m2/repository/com/org/
          retention-days: 1

  test-country-repos:
    needs: build-main-repo
    strategy:
      matrix:
        repo: [repo-pais-A, repo-pais-B, repo-pais-C]
      fail-fast: false  # Continuar aunque falle uno
    runs-on: ubuntu-latest
    steps:
      - name: Checkout country repo
        uses: actions/checkout@v3
        with:
          repository: MiguelMialdeaDev/${{ matrix.repo }}
          token: ${{ secrets.PAT_TOKEN || secrets.GITHUB_TOKEN }}

      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Download shared libs
        uses: actions/download-artifact@v4
        with:
          name: shared-libs
          path: ~/.m2/repository/com/org/

      - name: Setup Gradle
        uses: gradle/gradle-build-action@v2
        with:
          cache-read-only: false

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Update dependencies to SNAPSHOT
        run: |
          # Actualizar versión en todos los build.gradle.kts
          find . -name "build.gradle.kts" -exec sed -i 's/com\.org:shared-[^:]*:[^"]*"/com.org:shared-models:1.0.0-SNAPSHOT"/g' {} \;
          find . -name "build.gradle.kts" -exec sed -i 's/com\.org:shared-components:[^"]*"/com.org:shared-components:1.0.0-SNAPSHOT"/g' {} \;
          find . -name "build.gradle.kts" -exec sed -i 's/com\.org:shared-screens:[^"]*"/com.org:shared-screens:1.0.0-SNAPSHOT"/g' {} \;

      - name: Run Lint
        id: lint
        run: ./gradlew lint --no-daemon
        continue-on-error: true

      - name: Run Unit Tests
        id: test
        run: ./gradlew test --no-daemon
        continue-on-error: true

      - name: Build APK
        id: build
        run: ./gradlew assembleDebug --no-daemon 2>&1 | tee build_output.log
        continue-on-error: true

      - name: Extract compilation errors
        id: extract_errors
        if: steps.build.outcome == 'failure'
        run: |
          # Extraer errores de compilación de Kotlin
          echo "### Compilation Errors:" > error_summary.txt

          # Buscar errores de tipo "No value passed for parameter"
          grep -A 2 "error:" build_output.log | head -20 >> error_summary.txt || echo "No specific errors found" >> error_summary.txt

          # Extraer archivo y línea del error
          grep "e: file://" build_output.log | head -5 >> error_summary.txt || true

          cat error_summary.txt

      - name: Get PR changes
        id: pr_changes
        run: |
          # Obtener el diff de los archivos cambiados en esta PR
          git fetch origin master:master || true
          DIFF=$(git diff master...HEAD -- '*.kt' '*.kts' | head -100)
          echo "PR_DIFF<<EOF" >> $GITHUB_ENV
          echo "$DIFF" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

      - name: Report status
        if: steps.build.outcome == 'failure' || steps.test.outcome == 'failure'
        uses: actions/github-script@v6
        with:
          script: |
            const fs = require('fs');
            const buildFailed = '${{ steps.build.outcome }}' === 'failure';
            const testFailed = '${{ steps.test.outcome }}' === 'failure';

            let errorDetails = '';
            try {
              errorDetails = fs.readFileSync('error_summary.txt', 'utf8');
            } catch (e) {
              errorDetails = 'Error details not available';
            }

            // Extraer solo los errores relevantes (primeras 5 líneas con 'error:')
            const relevantErrors = errorDetails
              .split('\n')
              .filter(line => line.includes('error:') || line.includes('No value passed') || line.includes('e: file://'))
              .slice(0, 5)
              .join('\n');

            const prDiff = process.env.PR_DIFF || 'Diff not available';

            // Construir mensaje con template literals adecuados
            const message = `## ❌ Breaking Change Detected in \`${{ matrix.repo }}\`

${buildFailed ? `### 🔴 Build Failed

**Error:**
\`\`\`
${relevantErrors || 'Build compilation failed'}
\`\`\`
` : ''}
${testFailed ? '### 🧪 Tests Failed\n\n' : ''}
### 📝 What changed in repo-principal?

<details>
<summary>Click to view the changes that caused this issue</summary>

\`\`\`diff
${prDiff.substring(0, 800)}
\`\`\`

</details>

### 💡 How to fix this

**Option 1:** Add default values to new parameters
\`\`\`kotlin
// Instead of: val age: Int
// Use: val age: Int = 0
\`\`\`

**Option 2:** Update \`${{ matrix.repo }}\` to include the new parameter

**Option 3:** Use \`@Deprecated\` annotation for gradual migration

---
📋 [View full build logs](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
`;

            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: message
            });

      - name: Upload build logs
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: build-logs-${{ matrix.repo }}
          path: |
            **/build/reports/
            **/build/outputs/logs/
          retention-days: 5

  summary:
    needs: test-country-repos
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Post summary
        uses: actions/github-script@v6
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: '✅ **Validación de breaking changes completada**\n\nRevisa los checks anteriores para ver el estado de cada país.'
            });